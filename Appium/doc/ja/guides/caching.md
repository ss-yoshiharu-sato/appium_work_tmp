---
title: アプリケーションバンドル・キャッシングロジック
---

# アプリケーションバンドル・キャッシングロジック

<!-- Appium Base driver provides a feature which enables caching of application builds provided, for example, as `app` capability value or to endpoints similar to the `installApp` one. This article explains common caching principles, so you could create more performant and efficient test suite execution strategies. -->

Appium Baseドライバには、`app`capability値や`installApp`と同様の、エンドポイントに提供されるアプリケーションビルドのキャッシュを可能にする機能があります。この文書では、一般的なキャッシュの原則について説明します。これにより、よりパフォーマンスと効率の良いテストスイートの実行計画を作成できます。

<!-- ## Why Caching Is Necessary -->
## キャッシュが必要な理由

<!-- Mobile application bundles could reach hundreds of megabytes is size. This could become a serious performance issue if a test suite is executed, and it is necessary to fetch/extract the same application bundle for each test. -->

モバイルアプリケーションのバンドルのサイズは数百メガバイトに達することがあります。テストスイートが実行され、各テストで同じアプリケーションバンドルを取得/抽出する必要がある場合、これは深刻なパフォーマンス問題になりかねません。

<!-- ## What Is Cached -->
## キャッシュされるもの

<!-- Caching could be applied to application bundles generated by [configureApp](../../../../../packages/base-driver/lib/basedriver/helpers.js) helper call. Inherited drivers can customize their caching logic by providing own `onPostProcess` property definition, but the general rule of thumb is that we need to cache locally all application bundles need to be downloaded and/or extracted first before they could be actually installed on the device under test. On iOS, for example, these are .ipa or .zip compressed application bundles or .aab on Android. -->

キャッシュは、`configureApp` ヘルパーコールによって生成されたアプリケーションバンドルに適用できます。継承されたドライバは、独自の`onPostProcess`プロパティ定義によってキャッシュロジックをカスタマイズできますが、一般的な経験則では、テスト対象のデバイスに実際にインストールする前に、最初にダウンロードや抽出が必要なアプリケーションバンドルをすべてローカルにキャッシュする必要があります。例えば`iOS`では`.ipa`や`.zip`で圧縮されたアプリケーションバンドル、`Android`では`.aab`がこれにあたります。

<!-- ## How Remote Application Bundles Are Cached -->
## リモートアプリケーションバンドルがキャッシュされる方法

<!-- In order to validate whether an app bundle downloaded from the given URL could be (re)used from the cache the following steps are applied: -->
指定されたURLからダウンロードしたアプリケーションバンドルがキャッシュから（再）使用できるかどうかを検証するために、以下の手順が適用されます：

<!-- 1. The script is sending `HEAD` request to the given link in order to only fetch response headers. If this request fails/ times out then no caching is applied.
2. The following header values are being extracted: `Last-Modified`, `Cache-Control`. If no `Last-Modified` header is present or the header value cannot be parsed as a valid datetime then no caching is applied.
3. The script checks if the given URL is already present in the cache. If the app is not cached yet then it gets downloaded and its current header values along with hashsum are added to the cache.
4. If the URL was already in the cache then the script verifies that:
   - the current `Last-Modified` datetime is not different from the previous one
   - the difference between the current `Last-Modified` datetime and the cached one is not greater than max-age (if present)
   - the hashsum of the cached file/folder is not changed (e.g. it was not corrupted while sitting in the cache)
5. If all validations above succeed then the cached build is returned, otherwise the currently cached entry gets deleted and a new one is downloaded instead. -->

1. スクリプトは、レスポンスヘッダーのみをフェッチするために、与えられたリンクに`HEAD`リクエストを送信します。このリクエストが失敗したりタイムアウトした場合は、キャッシュは適用されません。
2. 次のヘッダー値が抽出されます:`Last-Modified`, `Cache-Control` Last-Modifiedヘッダが存在しない場合、またはヘッダ値が有効な日付として解析できない場合、キャッシュは適用されません。
3. スクリプトは、与えられたURLがすでにキャッシュに存在するかどうかをチェックします。アプリがまだキャッシュされていない場合、アプリがダウンロードされ、現在のヘッダー値とhashsumがキャッシュに追加されます。
4. URLがすでにキャッシュに存在する場合、スクリプトは以下を確認します：
   - 現在の `Last-Modified` の日付が以前のものと異なっていないこと。
   - 現在の `Last-Modified` の日付とキャッシュされた日付の差が max-age (存在する場合) よりも大きくない
   - キャッシュされたファイル/フォルダのハッシュサムが変更されていない（例えば、キャッシュに保存されている間に破損していないなど）
5. 上記の検証がすべて成功すれば、キャッシュされたビルドが返され、そうでなければ、現在キャッシュされているエントリーは削除され、代わりに新しいものがダウンロードされます。

<!-- ## How Local Application Bundles Are Cached -->
## ローカルアプリケーションバンドルがキャッシュされる方法

<!-- It only makes sense to cache application bundles if they need some preprocessing before being installed on the device under test. For example, on iOS .ipa bundles must be unzipped, because the system installer only works with .app folders. -->

アプリケーションバンドルがテスト対象のデバイスにインストールされる前に何らかの前処理が必要な場合のみ、キャッシュする意味があります。例えば、`iOS`の場合、`.ipa`バンドルは解凍する必要があります。なぜなら、システムインストーラは`.app`フォルダしか扱えないからです。

<!-- 1. The script verifies if the given bundle path is already present in the cache. If the bundle was not in the cache yet then it gets preprocessed and added there.
2. The script validates the hashsum of the bundle and compares it to the previously stored one. If hash sums don't match then the cached item gets deleted and the preprocessing of the bundle repeats. -->

1. スクリプトは、与えられたバンドルパスがキャッシュに既に存在するかどうかを確認します。バンドルがまだキャッシュにない場合は、前処理を行いキャッシュに追加します。
2. スクリプトは、バンドルのハッシュサムを検証し、以前に保存されたものと比較します。ハッシュサムが一致しない場合、キャッシュされたアイテムは削除され、バンドルの前処理が繰り返されます。

<!-- ## How The Cache File System Is Configured -->
## キャッシュファイルシステムの設定方法

<!-- The cache where the base driver keeps all application bundles is located in the system temp folder. It is configured on per-process basis, so each test session initialized in scope of the same Appium server process takes advantages of it. It is a [LRU Cache](https://www.npmjs.com/package/lru-cache) with the following limitations: -->

ベースドライバがすべてのアプリケーションバンドルを保持するキャッシュは、システムのtempフォルダに配置されています。これはプロセスごとに設定され、同じAppiumサーバプロセスのスコープで初期化された各テストセッションがこれを利用するようになっています。[LRU Cache](https://www.npmjs.com/package/lru-cache)であり、以下の制限があります：

<!-- - Max items: 1024
- Max time to live (TTL) for each entry: 24 hours
- TTL is refreshed for each entry upon access -->

- 最大アイテム数 1024
- 各エントリーの最大生存時間（TTL）：24時間
- TTLはアクセス時に各エントリに対してリフレッシュされる

<!-- !!! warning -->

<!-- Note: The cache root folder is set up for automatic deletion on Appium process termination. This would only work if Appium server is killed with SIGINT or SIGTERM. If SIGKILL is used then no cache cleanup awould be performed. -->

!!! warning
    注意：キャッシュのルートフォルダは、Appiumのプロセス終了時に自動削除されるように設定されています。これは、AppiumサーバがSIGINTまたはSIGTERMで終了した場合にのみ機能します。SIGKILLが使用された場合、キャッシュのクリーンアップは実行されません。
